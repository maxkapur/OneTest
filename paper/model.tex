%!TEX encoding = UTF-8 Unicode 
% !BIB program = biber
\documentclass[12pt]{article}
\usepackage{geometry}
\geometry{a4paper, margin=2.5cm} 
%\usepackage[parfill]{parskip} 
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{setspace}
\usepackage{caption}
\usepackage{cancel}
\setstretch{1.2}
\usepackage{graphicx}
\DeclareGraphicsExtensions{.pdf,.png,.jpg}
\usepackage{relsize}
\usepackage{times}
\usepackage{letltxmacro}

\usepackage[reflist=true,style=windycity]{biblatex}
\addbibresource{refs.bib}

\newtheorem{theorem}{Theorem}
\newtheorem{proposition}{Proposition}

\theoremstyle{definition}
\newtheorem{definition}{Definition}
\newtheorem{algorithm}{Algorithm}

\title{From centralized school choice problems to competitive admissions markets: On the equivalence of stable matchings and market equilibrium}
\date{\today}
\author{Max Kapur}
\begin{document}

\maketitle

\pagebreak
\tableofcontents

\pagebreak
\section{Introduction}
The classical \emph{school choice problem} is a one-to-many stable matching problem. Given a set of students and a set of schools, each student supplies her ranked preferences over the schools (typically without ties), and each school supplies its ranked preferences over the students (sometimes allowing for ties). Using a deferred acceptance algorithm in conjunction with a tiebreaking rule, the school board computes a \emph{stable assignment} of students to schools, or one in which every school that rejects students fills its capacity with students equal to or better than other students who prefer that school to the school to which they are matched.

Recently, attention has shifted toward a nonatomic formulation of this problem in which individual students are replaced with a distribution of students over the space of possible preference lists and scores. The nonatomic formulation, due to Azevedo and Leshno \parencite*{supplydemandfw}, enables the characterization of assignment policies, including stable assignments, via school admissions cutoffs, which indicate a score threshold above which all students have the option of attending the school in question. Current research in school choice problems takes advantage of the nonatomic formulation because it can be interpreted as the limit of the discrete assignment problem as the number of students and seats increases to infinity; thus, score cutoffs in the nonatomic formulation are free of the ``noise'' associated with discretization. 

However, formulating school choice problems in terms of cutoffs rather than stable assignments is also an opportunity to greatly generalize the purview of school choice research. In actuality, most admissions markets are not run by a central agency. Instead, they are dynamic: colleges can admit or reject students as they please, although it is safe to assume that to the extent that a given college can derive a partial preference order over the set of its applicants, it will admit the subset that exceeds a certain score cutoff rather than an arbitrary subset from all over the map. 

The cutoff formulation also creates space for the possibility that schools may have goals other than filling their capacity. They may not even have a meaningful limit on capacity, as is the case for many online schools.

In this dynamic situation, that paper offers a theoretical description of the relationship between supply and demand and posits a few comparative statics. However, it doesn't concern itself with computation, neither of the location of the equilibrium nor of the statics themselves. 

The one computable instance it does consider is with completely iid preferences on the part of the schools. then it provides expressions for comparative statics and a theoretical discussion about when negative incentives can arise.

It is this computational question to which I turn. I propose a continuous model that is both computationally tractable, moderately realistic, and versatile enough to accommodate not just centralized markets that used a DA procedure but also dynamic markets in which schools freely admit and reject students.

This model enables us to actually compute useful comparative statics. 

Moreover, it is realistic xyz.
I establish the equivalency between the notion of equilibrium defined in reference to the demand function and school capacities, and several notions of equilibrium rooted in quantitative economics, game theory, and mechanism design. In fact, most previous literature on school choice process considers a centralized ...

\section{Interpretations of equilibrium in admissions markets}
Before specifying the market used in this paper, I will define a nonatomic admissions market and summarize some important theoretical results.

\subsection{Admissions markets}
\begin{definition} An \emph{admissions market} consists of a set of schools $C = \{ 1\dots |C| \}$ and a mass-1 continuum of students over the set $S$ of student types. The market is characterized by four parameters:
\begin{enumerate}
\item The measure $\eta: 2^S \mapsto [0, 1]$ over the continuum of students.
\item The score cutoff vector $p \in [0, 1]^C$. 
\item The demand vector $D \in [0, 1]^C$.
\item The capacity vector $q \in \mathbb{R}_{++}^C$.
\end{enumerate}
\end{definition}

The model is \emph{nonatomic} in that it represents students as a probability measure over the set of student types instead of considering individual students as discrete actors. Each point $s$ in the set of student types $S$ is associated with a preference list over the schools $>_s$ and a percentile score at each school $\theta_{sc} \in [0,1]$. Hence, $S = C! \times [0, 1]^C$. 

Schools marginally prefer students with higher scores. Their admissions decisions are represented by the score cutoff vector $p$. Any student for whom $\theta_{sc} \geq p_c$ is said to be \emph{admitted} to school $c$. 

The demand vector represents the number of students who enroll at each school. Assume that each student attends her favorite school among the set of schools to which she is admitted, which is called her \emph{consideration set} $C^\# \in 2^C$. Then the demand for school $c$ is a function of $p$ and $\eta$; specifically, it is the measure of students who are admitted to school $c$ but not admitted to any school that they prefer to $c$:
\begin{equation} \label{demanddefinition}
D_c \equiv \eta\left(s: c = \arg \max_{>_s} \left\{\hat c: \theta_{s\hat c} \geq p_{\hat c} \right\}\right)
\end{equation}
Observe that $D_c$ is weakly decreasing in $p_c$ and weakly increasing in $p_{c'}$ for $c' \neq c$.
\begin{definition} \label{strongsupportdefinition}
$\eta$ is said to have \emph{strong support} if the preference lists are independent of the score vectors and each possible preference list has nonzero marginal density, and the marginal distribution of scores at each school has full support. 
\end{definition}
Furthermore, if $\eta$ has strong support or full support, then $D_c$ is strictly decreasing in $p_c$ and strictly increasing in $p_{c'}$ for $c' \neq c$. Intuitively, this means that the margin of students who would choose to attend $D_c$ if its cutoff decreased is never empty. Finally, observe that $p_c = 1 \implies D_c = 0$ regardless of the other schools' cutoffs.

If the preference lists are independent of the score vectors (for example, if $\eta$ has strong support), then the demand can also be expressed as the sum of the demand from each combination of preference list and consideration set:
\begin{gather} \label{demandbigsum}
\begin{aligned}
D_c = 
\sum_{>_s \in C!} \sum_{\substack{C^\# \in 2^{C}:\\ c \in C^\#}}
\eta\Big(\;s:&~~\underbrace{\theta_{sc'} \geq p_{c'}, \forall c' \in C^\#}_{\text{got into schools in } C^\# } \\
\text{ and} &~~\underbrace{\theta_{sc''} < p_{c''}, \forall c'' \in C \setminus C^\#}_{\text{rejected elsewhere}} \\
\text{ and} &~~\underbrace{c >_s \hat c, \forall \hat c \in C^\#\setminus \{c\}}_{\text{prefers } c \text{ among } C^\#} \;\Big)
\end{aligned}
\end{gather}
This expression yields immediate insight into the complexity of nonatomic admissions markets. When schools are allowed to set their own cutoffs, and students are given free choice among the schools in their consideration sets, the number of terms in the sum above is $|C|!\times2^{|C|}$. However, such a general characterization of students is not always needed. The model considered in this paper (\S\ref{modeldescription}), characterizes $S$ using only a $|C|$-vector of school preferability parameters. Alternatively, generic markets can be discretized by representing individual students using explicit preference lists and score vectors. 

Each school's capacity $q_c > 0$ represents the fraction of the total mass of students that the school can accept. The capacity is used to define the notion of equilibrium below.

Assume that students prefer to be assigned to any school, even their last choice, than to remain unassigned. This is without loss of generality; if some students prefer to be unassigned than attend a particular school, then this choice can be incorporated into the model by adding a dummy school, representing nonassignment, with arbitrary large capacity. 

Assume that almost no ties occur among scores at a given school. That is, for any fixed $c$ and constant $\bar \theta$, $\eta( s: \theta_{sc} = \bar \theta) = 0$. It follows that the demand is continuous in $p$. 

\subsection{Notion of equilibrium}
Let's consider a notion of equilibrium that turns out to have several realistic interpretations. 

\begin{definition} \label{marketeqconditions} An admissions market is in \emph{equilibrium} if the following conditions hold:
\begin{align} D_c &\leq q_c, \quad \forall c \label{capacitycondition} \\
D_c &= q_c, \quad \forall c: p_c > 0 \label{stabilitycondition}
\end{align}
The first condition, called the \emph{capacity condition,} says that no school's demand exceeds its capacity. The second, called the \emph{stability condition,} says that if a school is rejecting students, it must be at full capacity.
\end{definition}

Using the sign constraint on $p$ and the capacity condition, an equivalent to the stability condition is $D_c < q_c \implies p_c = 0$ or $p^T \left(D - q\right) = 0$.

As shown below, a sufficient condition for the existence of the equilibrium is that the demand is continuous in $p$. A sufficient condition for the uniqueness of the equilibrium is that the demand is strictly decreasing in $p$. As discussed above, both of these conditions are met if $\eta$ has strong support or full support. 
%The following assumptions ensure the existence of the equilibrium: First, restrict domain of $p$ to $[0,1]$. Demand decreasing in $p$. Full support in $\eta$. 

\subsection{Interpretation of the equilibrium conditions}
The applicability and interpretation of the equilibrium conditions depends on the design of the admissions markets. I offer four interpretations, moving from theoretical to practical. With additional assumptions on $\eta$, such as strong support, all four interpretations become sufficient conditions for equilibria as well. Additionally, the first interpretation establishes a sufficient condition for the existence of the equilibrium. 

In all cases, assume the distribution of student types $\eta$ and the school capacities $q$ are fixed; thus the demand $D(p)$ is determined entirely by the cutoffs $p$. 

\subsubsection{As a fixed point of a t\^{a}tonnement process} \label{asafixedpoint}
Suppose that each school has set an admissions target of $q_c$ and observes its demand from year to year. If more than $q_c$ students enroll, then the school attempts to reduce remand by increasing its cutoff. If fewer than $q_c$ students enroll, the school attempts to increase demand by lowering its cutoff (but not past zero). 

Let $Z(p) \equiv D(p) - q$ denote the excess demand vector. Then the process described above implies the following recursive relation between the cutoff vector in year $k$ and in year $k+1$:
\[p_c^{(k+1)} = \max\biggl\{0,~p_c^{(k)}+ \Gamma_c\Bigl[Z_c\bigl(p^{(k)}\bigr)\Bigr] \biggr\}\]
where $\Gamma$ is sign-preserving. A dynamic process like this one, in which prices adjust in the direction of excess demand, is called a \emph{t\^{a}tonnement process}.
\begin{theorem}
If $\bar p$ is a fixed point of the t\^{a}tonnement process, then it satisfies the equilibrium conditions. The converse also holds.
\end{theorem}
\begin{proof} Pick $\bar p$ such that $\bar p = \max\bigl\{0, \bar p_c + \Gamma_c\left[Z_c(\bar p)\right] \bigr\}$. Subtract $\bar p_c$ from both sides to obtain $0 = \max\bigl\{-\bar p_c,\Gamma_c\left[Z_c(\bar p)\right] \bigr\}$, which implies $0 \geq \Gamma_c\left[Z_c(\bar p)\right] \bigr\}$. This means that the excess demand is negative, which establishes the capacity condition. Now, suppose $\bar p_c > 0$; then $\bar p_c =  \bar p_c + \Gamma_c\left[Z_c(\bar p)\right] $ establishes the stability condition $Z_c(\bar p = 0)$. Hence, any fixed point of the t\^{a}tonnement process is an equilibrium. 

As for the converse, if $p^{(k)}$ satisfies the equilibrium conditions, it is easy to verify that $p^{(k+1)} = p^{(k)}$. \end{proof}

Moreover, if the demand function is continuous in $p$, then Brouwer's fixed-point theorem guarantees that a fixed point exists, because the cutoff update maps the convex set $[0, 1]^C$ to itself. This means that continuous demand is sufficient for the existence of an equilibrium in admissions markets. 

Quantitative economists have studied t\^{a}tonnement processes extensively. For an introduction, see Codenotti and Varadarajan \parencite*{compmkteq} or Intriligator \parencite*[][chap. 9]{mathematicaloptandecontheory}. A classical proof of various convergence conditions is Uzawa \parencite*{walrastatonnement}. 

\subsubsection{As a competitive (Nash) equilibrium} \label{asacompeq}
Suppose that each school's capacity $q_c$ is a physical constraint on the number of students it can admit. Each school would like to recruit as many students as possible. However, if more students choose to attend the school than the school has capacity for, it must rent additional classroom space at considerable expense. Pick a school $c$ and fix the cutoffs at the other schools $p_{c'}$ . Let $u_c(p_c; p_{c'})$ denote school $c$'s utility function, and $\hat p_c \equiv p_c: D_c(p_c; p_{c'}) = q_c$ denote the cutoff value that causes $c$ to fill its capacity, if such a value exists. In the situation described, $u_c$ is increasing in $p_c$ when $0 \leq p_c \leq \hat p_c$, decreasing in $p_c$ when $p_c > \hat p_c$, and the fixed costs associated with excess demand are nonnegative: \[\lim_{p_c \to \hat p_c^+} u_c(p_c; p_{c'}) \leq  u_c(\hat p_c; p_c{c'})\]
Another scenario in which utility functions with this shape may arise is as follows: Schools' utility functions are determined mostly by the number of students they enroll, and to a lesser extent by their average score. If the demand for a school is less than its capacity, then a marginal student is always desirable. On the other hand, if the demand exceeds the capacity, then the school has no ability to procure space for the excess demand. Instead, it allows students to register on a first come, first served basis. Because the set of registered students is a random subset of the students who attempt to enroll at the school, it provides the school with less overall utility than if it handpicked the $q_c$ students with the highest scores. That is, $u_c$ is increasing when $0 \leq p_c \leq \hat p_c$, and decreasing when $p_c > \hat p_c$. 

In both of these situations, the admissions market equilibrium can be interpreted as a Nash equilibrium. 
\begin{theorem}
Consider the game in which each school picks a cutoff $p_c \in [0,1]$ and tries to maximize a utility function $u_c$ that is increasing in $p_c$ when $0 \leq p_c \leq \hat p_c$, decreasing in $p_c$ when $p_c > \hat p_c$, and satisfies $\lim_{p_c \to \hat p_c^+} u_c(p_c; p_{c'}) \leq  u_c(\hat p_c; p_c{c'})$.

If $p^*$ satisfies the equilibrium conditions, then it is a Nash equilibrium of the game above. If the utility functions are strictly increasing or decreasing, the converse is also true.
\end{theorem}
\begin{proof} Suppose $p^*$ satisfies the admissions market equilibrium conditions. For the schools for which $D_c = q_c$, their utility is globally maximal. For a school for which $D_c < q_c$, the only way for the school to increase its utility is to decrease its cutoff, but by assumption, $p_c^* = 0$. Hence, is incentivized to change its cutoff, and $p^*$ is a Nash equilibrium of the game defined by the schools' utility functions and the action space $p_c \in [0, 1]$.

The converse can be shown similarly.\end{proof}

As an aside, observe both of the above are natural situations in which the t\^{atonnement} dynamics may arise.

\subsubsection{As a market-clearing cutoff vector} \label{mktclearingproc}
Consider a semicentralized admissions procedure similar to the one used for college admissions in South Korea. In order to ensure an even geographic distribution of students, the government places a firm limit $q_c$ on the number of students who can attend each university. At the beginning of the admissions cycle, colleges are given the profiles of all the students interested in attending. Each college makes admissions offers over the course of several rounds, beginning with the highest-qualified students, and at each round a subset of the admitted students tentatively commit to attending one of the colleges that admitted them. Continuing in this manner, colleges continue lowering their cutoffs and offering admission to new students until either they fill their capacity, or lowering the cutoff fails to elicit an increase in demand. That is, the process terminates when the \emph{market clears:} There may be empty seats at some schools or some students who were admitted nowhere, but never both. The total measure of assigned students is $\min\{1, \sum_c q_c\}$.

\begin{theorem}
If $\hat p$ is a market-clearing cutoff vector obtained from the semicentralized admissions procedure, then it satisfies the equilibrium conditions.

Conversely, if $\hat p$ satisfies the equilibrium conditions, then it is a market-clearing cutoff vector. That is, the total measure of assigned students is $\min\{1, \sum_c q_c\}$. 
\end{theorem}

\begin{proof}Call the final vector of admissions cutoffs $\hat p$. If we assume that student preference lists are independent of their scores and that the marginal distribution of scores at each school has full support, then it follows that market-clearing cutoffs $\hat p$ satisfy the equilibrium conditions. The capacity condition holds at $\hat p$, because colleges are prohibited from lowering their cutoffs beyond the point where the demand equals the capacity. The stability condition also holds: Suppose (for a contradiction) that at the end of the final round, there is a school which has both remaining capacity (that is, $D_c < q_c$) and a positive cutoff $\hat p_c > 0$. By the full support assumption on the marginal score distribution, the set of marginal students at $c$ is nonempty. Hence, if $c$ lowers its cutoff, it can attract additional students. This contradicts the stopping criterion.

As for the converse, let $\hat \eta$ denote the measure of assigned students: $\hat \eta \equiv \sum_c D_c(\hat p)$. By the capacity criterion, we have $\hat \eta \leq \sum_c q_c$. Since every student prefers assignment to nonassignment, $\hat \eta = 1 - \eta ( s: \theta_{sc} < p_c, \forall c \in C) \leq 1$. If at least one school has $p_c = 0$, then $\hat \eta = 1 \leq q_c$ and the statement holds. Otherwise, the stability condition applies to every school, meaning $\hat \eta = \sum_c q_c \leq 1$ . 
\end{proof}

In reference to this interpretation of the equilibrium conditions, Azevedo and Leshno \parencite*{supplydemandfw} refer to the capacity and stability constraints as the market-clearing equations. 

The semicentralized admissions procedure can be interpreted as a t\^{a}tonnement process in which the initial cutoffs are a vector of ones, or as a distributed school-proposing deferred acceptance process, as discussed below (\S\ref{defaccaretat}).

\subsubsection{As a stable matching}
The final interpretation of the equilibrium conditions comes from Lemma 1 of Azevedo and Leshno \parencite*{supplydemandfw}, which says that there is a one-to-one relationship between stable matchings and equilibrium cutoff vectors. In this section, I offer a proof of this lemma. 

The notion of a stable assignment has its roots in the field of mechanism design, and thus emerges most naturally from a centralized school choice process as follows: Before the school year begins, students fill out an online form indicating their preference order over the set of schools in the district. Likewise, schools submit their preference order over the students (or equivalently, the scores they have given to each student) to the school board. Then, the school board determines the assignment of students to schools. 

First, some notation. A assignment is a mapping of students to schools.
\begin{definition}
A school choice \emph{assignment} is a mapping $\mu: S \to C \cup \{c_0\}$. $\mu(s) = c_0$ represents nonassignment.
\end{definition}
The school board is interested in matchings, or assignments that respect capacity constraints. 
\begin{definition}
A \emph{matching} is an assignment $\mu$ that respects schools' capacity constraints; namely, $\eta (s: \mu(s) = c) \leq q_c, \forall c \in C$. 
\end{definition}
To protect itself from lawsuits and encourage honest participation in the assignment process, the school board decides to rule out matchings that create justified envy; that is, matchings in which a student $s$ who prefers school $c$ to $c'$ is assigned to $c'$ despite scoring higher than a student assigned to $c$, or $c$ having remaining capacity. In such a situation, $(s, c)$ is called a blocking pair, and a stable matching is a matching that does not admit any blocking pairs.
\begin{definition}
A \emph{stable matching} (or \emph{stable assignment}) is a matching $\mu$ that admits no blocking pairs. That is, there exist no tuples $(s, c)$ s.t. $c >_s \mu(s)$ and one of the following holds:
\begin{itemize}
\item School $c$ has remaining capacity:
\[\eta\bigl(s: \mu(s) = c \bigr) < q_c\]
\item (And/or,) school $c$ has admitted an inferior student:
\[\exists s' \neq s: \mu(s') = c \text{ and } \theta_{s'c} < \theta_{sc}\] 
\end{itemize}
These are called type I and type II blocking pairs, respectively.
\end{definition}

In a nonatomic admissions market, where the number of students is infinite, the definition above offers no guidance as to how to encode a stable matching $\mu$. However, it turns out that stable matching are in one-to-one correspondence with equilibrium cutoff vectors. Therefore, any stable matching $\mu$ can be fully encoded by a $|C|$-vector of cutoffs $p$. This fact is invaluable in a computional context.

To establish this result, we must define operators that take cutoff vectors to assignments, and vice-versa. First, the assignment of students induced by instating the cutoff vector $p$ and allowing students to choose freely among their consideration set is
\[\mu_p(s) \equiv \max_{>_s} c \in C : \theta_{sc} \geq p_c, \qquad \forall s \in S\]  % fix to theta notation
Note that this assignment is not necessarily a matching because it may violate the capacity constraints. 

Second, the following expression gives the admissions cutoffs implied by a given matching $\mu$, namely, the minimum score of the students admitted to each school:
\[p_c(\mu) \equiv \min \left\{\theta_{sc}: \mu(s) = c\right\}\]
In general, these operators are not necessarily inverses of one another. However, as implied by the following theorem, they are inverses when we restrict their domains to the sets of equilibrium cutoffs and stable matchings, respectively. 

\begin{theorem}If $p^*$ satisfies the equilibrium conditions, then $\mu_{p^*}$ is a stable matching. 

Conversely, if $\bar \mu$ is a stable matching and $\eta$ has full or strong support, then $p_c(\bar \mu)$ satisfies the equilibrium conditions. \end{theorem}

\begin{proof}Pick an equilibrium cutoff $p^*$. Then by the definitions of the demand function \eqref{demanddefinition} and equilibrium conditions \eqref{marketeqconditions}, 
\begin{align*}
D_c(p^*) = \eta\bigl(s: \mu_{p^*}(s) = c\bigr) &\leq q_c, \quad\forall c \in C \\
D_c(p^*) = \eta\bigl(s: \mu_{p^*}(s) = c\bigr) &= q_c, \quad \forall c: p_c^* > 0 
\end{align*}
By the capacity condition, no school exceeds its capacity, so $\mu$ is an assignment. By the stability condition, there are no type I blocking pairs. And there are no type II blocking pairs, because if a student fails to meet the cutoff for a school she prefers to $\mu_{p^*}(s)$, it is because the school has replaced her with students who got higher scores. Hence, $\mu_{p^*}$ is a stable matching.

The converse is proven as follows. Fix a stable matching $\bar \mu$, and let $\bar p \equiv p(\bar \mu)$. To get a contradiction, suppose $\bar p$ is not an equilibrium. This can happen in two ways:
\begin{itemize}
\item For some school $c$, $D_c( \bar p) > q_c$. This means $D_c( \bar p)  >  \eta\bigl(s: \bar \mu(s) = c\bigr) $, which implies the existence of a student $s$ who is admitted to $c$ at $\bar p$ (that is, $\theta_{sc} \geq \theta_{s'c}$ for some $s': \bar \mu(s') = c$) and prefers $c$ among her consideration set, but for whom $\bar \mu(s) \neq c$. Then $(s, c)$ is a type II blocking pair; hence, $\bar \mu$ is not a stable matching.
\item For some school $c$, $\bar p_c > 0$ and $D_c(\bar p) < q_c$. By the assumption of strong or full support, there is a student $s$ for whom $c >_s \bar \mu(s)$ and $\theta_{sc} < \bar p_c$. The latter implies that $\bar \mu(s) \neq c$. Hence, $(s, c)$ is a type I blocking pair, and $\mu$ is not a stable matching. 
\end{itemize}
Therefore, $\bar p$ must satisfy the equilibrium conditions.
\end{proof}

\subsection{Deferred acceptance algorithms as t\^{atonnement} processes} \label{defaccaretat}
The classical solution to the stable matching problem is known as a deferred acceptance (DA) mechanism, which comes in many flavors. When neither students' nor schools' preference lists contains ties, the student-proposing DA procedure is a deterministic algorithm for a stable matching.  In this section, I first define the student- and school-proposing DA algorithms. Then, I show that DA algorithms are t\^{a}tonnement processes.

\begin{algorithm} \label{studentproposingDA}
The \emph{student-proposing deferred acceptance algorithm} is as follows. Given each student's preference order $>_s$ over the set of schools, without ties;  each school's score distribution $\theta_{.c}$ over the set of students, with zero probability of ties; and the capacity $q_c$ of each school, the following steps are repeated until no rejections take place:
\begin{enumerate}
\item Each student applies to the school highest on her list.
\item Each school examines the applications it received. If it received more applicants than it can seat, it rejects its least-favorite applicants such that the remaining applicants fill its capacity exactly.
\item Each rejected student removes the school that rejected her from her list.
\end{enumerate}
When the algorithm terminates, return the assignment $\mu$, where $\mu(s)$ is highest school remaining on $s$'s preference list, or $c_0$ if no schools remain. 
\end{algorithm}
The properties of the resultant assignment are well known: In the discrete case with $|S|$ students and $|C|$ schools, the algorithm terminates in at most $|S||C|$ iterations. The resultant matching $\mu$ is stable. $\mu$ is also strongly student optimal, meaning that if another assignment $\mu'$ is chosen from the set of stable matchings, then $\mu(s) \geq_s \mu'(s)$ for all students $s$, and there is at least one student for whom $\mu(s) >_s \mu'(s)$. Similarly, the resultant assignment is strongly school pessimal, meaning any other stable assignment yields the same or better students at each school. Finally, the algorithm is weakly incentive compatible for individual students. That is, no student can obtain a better match than $\mu(s)$ by falsifying her preference list. Succinct proofs of these results are given in Roth \parencite*{economicsofmatching}.

It is worthwhile to compare school-proposing reverse DA. 
\begin{algorithm}
The \emph{school-proposing deferred acceptance algorithm} is as follows. Given each student's preference list $>_s$ over the set of schools and each school's scores $\theta_c$ over the set of students, both without ties, and the capacity $q_c$ of each school, the following steps are repeated until no rejections take place:
\begin{enumerate}
\item Each school proposes to the $q_c$ applicants in its consideration pool. If fewer than $q_c$ students are left, the school proposes to all remaining students.
\item Each student examines the proposals she received, rejecting all but her favorite.
\item Each school removes students who rejected it from its consideration pool.
\end{enumerate}
When the algorithm terminates, return the assignment $\mu$, where $\mu(s)$ is the school $s$ prefers among those that proposed to her, or $c_0$ if she received no proposals.
\end{algorithm}
This algorithm has symmetrical properties to those of forward DA, including student pessimality and incentive compatibility for the schools (but not the students).  For these reasons, student-proposing deferred acceptance is seldom used in school choice, and its counterpart in the National Residency Matching Program was abandoned in favor of a resident-proposing algorithm. However, in practice the differences among the resulting assignments tend to be minor. % cite

Under the constraint of stable assignment, student and school utility (as quantified by the preference orders) trade off directly. The student-optimal stable matching from student-proposing DA and the school-optimal stable matching from school-proposing DA define two extreme points of the set of all possible stable matchings, and they are linked by exchanging cycles of students such that student utility increases and school utility decreases, or vice-versa. This means that in a discrete context, to find \emph{all} stable matchings, it suffices to run only the student-proposing DA algorithm, then search recursively for cycles that move the assignment toward student pessimality. Such a procedure allows us to formulate the optimal stable matching problem as the maximal closure of the cycle dependency graph \parencite[][]{efficientalgorithmoptimal}. 

\begin{theorem}When $\eta$ has strong or full support, the student-proposing DA algorithm is a t\^{a}tonnement process in which the initial cutoff vector is $p = \vec 0$, and the school-proposing DA algorithm is a t\^{a}tonnement process in which the initial cutoff vector is $p = \vec 1$. \end{theorem}
\begin{proof}
Consider the case of student-proposing DA, and let $\mu^{(k)}$ denote the tentative assignment formed at each iteration of the algorithm. That is, $\mu^{(k)}(s)$ is the school at the top of $s$’s preference list at the beginning of the $k$th iteration.

It suffices to prove the following three statements:
\begin{enumerate}
\item Each $\mu^{(k)}$ is characterized by a cutoff vector $p^{(k)}$.

Fix $k$, let $p^{(k)} \equiv p\left(\mu^{(k)}\right)$, and let $m = \mu_{p^{(k)}}$. I will show that $m = \mu^{(k)}$. Pick a student $s$ and let $c = m(s)$. Since $s$ is among the set of students who determined the cutoff vector $p^{(k)}$, $ \mu^{(k)}(s)$ is still in $s$’s consideration set under these cutoffs; hence,  $c \geq_s \mu^{(k)}(s)$.  Now suppose $c >_s \mu^{(k)}(s)$. Since $s$ prefers $c$, she must have been applied to $s$ in a previous round and been rejected. This implies $p^{(k)}_{c} > \theta_{sc}$; hence $s$ is not admitted to $c$ in $m$, a contradiction. It follows that $m(s) = \mu^{(k)}(s)$. 

\item The initial cutoff vector has $p^{(0)} = \vec 0$.

At the beginning of the first iteration, each student is tentatively assigned to her favorite school. By the support assumption, for all schools $c$, the set of students who have $c$ at the top of their list and whose score is almost zero is nonempty. Hence, the minimum score over the tentative assignment at each school is zero.

\item $p^{(k+1)}$ is related to $p^{(k)}$ by a t\^{a}tonnement update.

At the beginning of each iteration of student-proposing DA, students who were not rejected in the previous iteration apply to the same school as before; on the other hand, students who were rejected apply to new schools. This means that students who apply to school $c$ at the $k$th iteration and are \emph{not} rejected are a subset set of students who apply at the $k+1$th iteration; hence, at every school $c$, $p_c^{(k+1)} \geq p^{(k)}$.

Suppose $p_c^{(k+1)} > p_c^{(k)}$. This implies that $c$ rejected students during iteration $k$, which can occur only if the number of students tentatively matched to $c$ at $k$ exceeds $c$’s capacity. Hence, $D_c ( p^{(k)}) > q_c$, and the excess demand $Z_c(p^{(k)})$ is positive at $k$. This agrees with the sign of the change in cutoff. 

Suppose $p_c^{(k+1)} = p^{(k)}$. This means that $c$ made no rejections during the $k$th iteration, or equivalently, that the number of students tentatively assigned to $c$ is less than or equal to $q_c$. In our notation, $\eta(s: \mu^{(k)} (s) = c)  = D_c (p^{(k)}) \leq q_c$. Hence the excess demand $Z_c(p^{(k)})$ is nonpositive. If $Z_c(p^{(k)}) = 0$, then the statement holds. If $Z_c(p^{(k)}) < 0$, then the statement holds only if $p_c^{(k)} = 0$. To get a contradiction, suppose $p_c^{(k)} > 0$. By the support assumption, there are students whose score is less than $p_c^{(k)}$ who have ranked $c$ first. These students applied to $c$ in an earlier round---call it $j$---and were rejected. This implies $c$ filled its capacity at $j$. Since the students not rejected at $j$ continue to apply to $c$ unless rejected again, $c$ fills its capacity at all subsequent rounds, including round $k$. Hence $Z_c(p^{(k)}) \geq 0$, a contradiction.
\end{enumerate}
The case of school-proposing DA is analogous. 
\end{proof}

Using this result, we can rewrite the DA algorithms above in a ``computational'' form that uses the cutoff vector $p$ as the state variable. In fact, allowing $p^{(0)}$ to take an arbitrary value, we can define a whole subclass of t\^{a}tonnement processes that use deferred acceptance to update the cutoff vector. I conjecture that this process converges regardless of the value of the initial cutoff vector. However, even if that conjecture is true, we still have some distance to tread before arriving at a general algorithm for admissions market equilibrium, because the process defined below does not specify how to compute the demand vector or its roots.
\begin{algorithm}
A \emph{deferred acceptance t\^{a}tonnement process} is as follows. Given an initial cutoff vector $p^{(0)}$, each student's preference order $>_s$ over the set of schools, without ties;  each school's score distribution $\theta_{.c}$ over the set of students, with zero probability of ties; and the capacity $q_c$ of each school, the following steps are repeated until $p^{(k+1)} = p^{(k)}$: For $k = 0, 1, \dots$, 
\begin{enumerate}
\item Compute the demand vector $D (p^{(k)})$. 
\item For each school $c$ for which $D_c > q_c$, increase the cutoff so that
\[p_c^{(k+1)} \equiv p_c: D_c(p_c; p_{c'} ) = q_c\]
\item For each school $c$ for which $D_c < q_c$, decrease the cutoff (but not past zero) so that
\[p_c^{(k+1)} \equiv \begin{cases}
p_c: D_c(p_c; p_{c'} ) = q_c, &\text{if such a } p_c \text{ exists}\\
0, &\text{otherwise}
\end{cases}\]
\item Otherwise, let $p_c^{(k+1)} \equiv p_c^{(k)}$.
\end{enumerate}
When the algorithm terminates, return $p_c^{(k)}$. 
\end{algorithm}
Taking $p^{(0)} = \vec 1$, it is easy to see that the the school-proposing deferred acceptance t\^{a}tonnement process is a stylized form of the market-clearing procedure described above (\S\ref{mktclearingproc}).

This algorithm bears a strong resemblance to the so-called successive t\^{a}tonnement process in which each company adjusts its price to the value that clears its supply under the assumption that other companies' prices are fixed \parencite[see][eqn. 6]{walrastatonnement}. 

\subsection{Computing the equilibrium} \label{computingtheeq}
With the results above in hand, let's consider a general admissions market in which $\eta$ and $q$ are fixed. We want to compute the equilibrium of this market. It is impractical to apply a DA algorithm to nonatomic admissions markets, because DA requires using exact line search to determine the new cutoff value for each school, and in general the demand is difficult to compute.

A moderate improvement over the deferred acceptance t\^{a}tonnement process is to use a \emph{simultaneous} t\^{a}tonnement process, similar to the one proposed above (\S\ref{asafixedpoint}), that evaluates the demand vector once per iteration and updates the cutoffs in the direction of the excess demand according to a predetermined sequence of decreasing step sizes. Under a light assumption on $D$, such as continuity, this process can be used to compute the equilibrium to arbitrary precision.
\begin{algorithm} \label{admissionseqtatalgo}
The \emph{admissions equilibrium t\^{a}tonnement algorithm} is as follows. Given an initial cutoff vector $p^{(0)}$, market parameters $\gamma$ and $q$, step parameters $\alpha >0$ and $0 \leq \beta < 1$, and a tolerance parameter $\epsilon$:
\begin{enumerate}
\item Compute the excess demand $Z = D (p^{(k)}) - q$. 
\item Update the cutoffs:
\[ p_c^{(k+1)} \equiv p_c^{(k)} + \frac{\alpha}{(k+1)^\beta} Z_c\]
\item Terminate if $| p_c^{(k+1)} - p_c^{(k)} | < \epsilon, \forall c$; otherwise, set $k \equiv k+1$ and repeat. 
\end{enumerate}
When the algorithm terminates, return $p_c^{(k)}$. 
\end{algorithm}
If the demand is continuous, convergence to an $\epsilon$-approximate equilibrium is guaranteed by the fact that the sequence of step sizes satisfies the Robbins--Monro conditions \parencite[][]{robbinsmonro}. However, algorithm is not necessarily computationally efficient. Although a good choice of parameters can enable the algorithm to terminate in a small number of iterations, in general, evaluating the demand vector at each iteration incurs a high computational cost. For example, even under the assumption of independence between students' preference orders and score vectors, the number of terms in each school's demand can be $|C|! \times 2^{|C|}$, as shown in equation \eqref{demandbigsum}.

Alternatively, if we have the ability to sample student preference lists and score vectors from $\eta$, then we can exploit the relationship between equilibrium cutoffs and stable matchings to estimate the equilibrium cutoffs with high confidence in polynomial time. The technique is as follows: Draw a discrete sample from $\eta$ and run a DA algorithm. Then compute the minimum score at each school in the resultant stable assignment. If student-proposing DA is used, the expected value of each the cutoffs from the student-optimal stable match approaches the equilibrium cutoff value from below as the size of the sample goes to infinity \parencite[][]{supplydemandfw}. Similarly, if school-proposing DA is used, the expected value of the obtained cutoffs approaches the equilibrium from above. 

Above, I described an expensive, guaranteed-precision technique and a cheap, stochastic technique for computing the equilibrium. One motivation for the model considered below (\S\ref{modeldescription}) is the fact that the equilibrium can computed in closed form by solving a linear system in $|C|$ equations for $p$, providing a baseline against which to evaluate the performance of these techniques. 

\subsection{Equivalent formulations of the equilibrium conditions}
The conditions for a market-clearing cutoff vector given in Definition \ref{marketeqconditions} can be expressed in a few additional ways. Throughout this section assume $\eta$ and $q$ are fixed and use \[F(p) \equiv -Z(p) = q - D(p)\]
to denote the excess supply vector at $p$. 

\subsubsection{Nonlinear complementarity problem}
By inspection, the market-clearing cutoff problem is equivalent to the following nonlinear complementarity problem:
\begin{gather} \label{nonlinearcompprob}
\begin{aligned}
\text{find } p:\quad F(p)^T p & = 0 \\ F(p) &\geq 0 \\ p & \geq 0
\end{aligned}
\end{gather}

\subsubsection{Variational inequality problem}
By a canonical result, the following variational inequality problem is also equivalent:
\begin{align*}
\text{find } p \geq 0:\quad F(p)^T (\pi-p) \geq 0, \quad \forall \pi \geq 0
\end{align*}
If $D$ is strictly decreasing in $p$, then $F$ is strictly increasing, and $p^*$ is unique \parencite[][\S2]{theoryofvariationalinequalities}. This, combined with the argument above establishing the existence of equilibrium (\S\ref{asafixedpoint}), yields the following theorem:
\begin{theorem} \label{strongsupportimpliesunique}
If $\eta$ has strong support, then the admissions market equilibrium exists and is unique.
\end{theorem}
Full support in $\eta$ is also sufficient.

\subsubsection{Convex optimization problem}
Suppose that the excess supply function $F$ defines a conservative vector field. This means that there exists a potential function (Lyupanov function) $\Phi(p)$ whose gradient is $F$:
\[\exists \Phi: \nabla_p \Phi = F\]
Such a potential function does not necessarily exist for every excess supply function. In fact, in the market considered below (\ref{modeldescription}), the Jacobian of $F$ is asymmetric, which implies that $F$ is \emph{not} a conservative vector field. 

However, supposing $\Phi$ exists, the equilibrium can be found by solving the following concave maximization problem:
\begin{align*}
\text{minimize} \quad \Phi(p) \qquad \text{subject to} \quad  p \geq 0 
\end{align*}
As the feasible set has nonempty interior, Slater's condition holds, and the optimal solution $(p^*, \lambda^*)$ satisfies the following KKT conditions:
\begin{align*}
&F_c - \lambda^* = 0 & \text{(stationarity)}\\
&p^* \geq 0, ~~ \lambda^* \geq 0  & \text{(primal, dual feasibility)}\\
&\lambda^{*T} p^*=0  & \text{(complementarity)}
\end{align*}
Eliminating the dual variables $\lambda^*$ yields the nonlinear complementarity problem above \eqref{nonlinearcompprob}; hence, $p^*$ is an equilibrium. Moreover, observe that the t\^{a}tonnement procedure of Algorithm \ref{admissionseqtatalgo} is a projected gradient ascent algorithm for this convex program, and vice-versa. 

\subsection{Optimization tasks}
With the equivalence results established above in hand, we can expand our understanding of admissions markets to encompass a range of optimization tasks that span a variety of realistic scenarios.

First, there is the canonical school-choice problem. Given  $\eta$ and the capacity vector $q$, we must compute a stable matching $\mu$. It suffices to find the equivalent cutoff vector $p$, as discussed above (\S\ref{admissionseqtatalgo}).

Second, there is the \emph{inverse optimization} problem. Given $p$ and demand $D$, we try to infer information about $\eta$ such as the overall preferability of each school or the joint distribution of students' scores. This task requires many simplifying assumptions, because the number of student distributions that could induce a given stable assignment is typically infinite. 

In the second half of this study, I turn to an example of a nonatomic admissions markets in which all of these problems can be solved efficiently, even when the number of schools is relatively large. 

\section{Single-score model with multinomial logit preferences} \label{modeldescription}
This section of the study considers a special kind of admissions market that has not received much attention in the school-choice literature but approximates the admissions procedure used in many systems around the world. From the standpoint of computing stable matchings, it is relatively simple: All schools have the same preference order, and students' preference orders are determined by the multinomial logit choice model. It is easy to generate a discrete sample of students.

However, this model also admits a piecewise expression for the demand that is locally invertible, which enables us not only to compute the equilibrium cutoffs exactly, but also to compute the gradient of the market parameters with respect to one another both in and out of equilibrium. This enables an interesting econometric analysis of the incentives available to schools.

\subsection{Model description} 

\subsubsection{Characterization of $\eta$}

To characterize $\eta$, we must describe both how schools rank students, and how students rank schools.

In a \emph{single-score model,} all schools share the same ranking over the students. A single-score system may arise in one of several real-world scenarios. The most obvious case is a centralized admissions market in which the government requires schools to admit students solely on the basis of a single standardized test. Alternatively, if students are scored using various dimensions of student characteristics such as test scores, GPA, and the quality of their letters of recommendation, it is common for these various dimensions to correlate tightly. If so, then principle component analysis can be used to determine a composite score whose order approximates the ordering of students at each university. Finally, in many public school systems, schools have no preference order over the students; instead students take turns picking their favorite school in an order determined by random lottery, or (equivalently) the single tiebreaking mechanism is used to generate schools’ preference lists and the assignment of students to schools is computed using student-proposing DA \parencite[][]{whatmatters}. 

Regardless of the device used to generate the single scores, taking percentile scores over the final distribution allows us to assume that the scores are uniformly distributed on the interval $[0,1]$. 

As for students' choice of school, this paper assumes students use \emph{multinomial logit} (MNL) choice to derive their preference lists. This means that each school has a given preferability parameter $\delta_c$. Letting $C^\# \subseteq C$ denote set of schools to which a given student is admitted, she chooses to attend school $c \in C^\#$ with
\[\frac{\exp \delta_c}{\sum_{d \in C^\#} \exp \delta_d}\]
For convenience, let $\gamma_c \equiv \exp \delta_c > 0$ and $\Gamma = \sum_c \gamma_c$. Since the equation is homogeneous in $\gamma$, we may assume without loss of generality that $\Gamma = 1$; however, I will resist this assumption since many parameter-estimation techniques for MNL choice do not use it. 
Observe that in the single-score model with MNL choice, $\eta$ has strong support (see Definition \ref{strongsupportdefinition}). 

\subsubsection{Demand function}
Let's derive the demand function $D(\gamma, p)$ for the single-score model with MNL student preferences.

First, sort the schools by cutoff, i.e. so that
\[p_1 \leq p_2 \leq \dots \leq p_{|C|}\]
Ties may be broken arbitrarily, as discussed below. Since getting into school $c$ implies getting into any school whose cutoff is less than or equal to $p_c$, there are only $|C| + 1$ possible consideration sets for each student: 
\begin{center}
\begin{tabular}{lll}
\textbf{Symbol} & \textbf{Consideration set} & \textbf{Probability} \\ \hline
$C_{[0]}$    & $\varnothing$    & $p_1$                  \\
$C_{[1]}$    & $\left\{ c_1 \right\}$    & $p_2 - p_1$               \\
$C_{[2]}$    & $\left\{ c_1, c_2 \right\}$    & $p_3 - p_2$               \\
$\vdots$ & $\vdots$ & $\vdots$ \\
$C_{[|C| - 1]}$           & $\left\{ c_1, \dots, c_{|C| - 1} \right\}$     & $p_{|C|} - p_{|C|-1}$             \\
$C_{[|C|]}$           & $\left\{ c_1, \dots, c_{|C|} \right\}$     & $1 - p_{|C|}$                 
\end{tabular}
\end{center}
Hence, the demand for school $c$ is the sum of the number of students with each of these consideration sets who choose to attend $c$. Letting $p_{|C|+1} \equiv 1$, that is
\begin{equation}D_c = \mathlarger{\mathlarger{\sum}}_{d=c}^{|C|} 
\underbrace{\frac{\exp{\delta_c}}{ \sum_{i=1}^d \exp{\delta_i}}}_{\substack{\text{prob. of choosing  }\\ c\text{ from cons. set}}} 
\overbrace{\left(p_{d+1} - p_{d}\right)}^{\substack{\text{prob. of having}\\ \text{cons. }C_{[d]}}} 
\label{mnlonetestdemand}\end{equation}
If at least one school has $p_c = 0$, then every student can get in somewhere, and $\sum_c D_c = 1$. Generally, there are $p_1$ students who get in nowhere, and $\sum_c D_c = 1 - p_1$.

\subsubsection{Properties of the demand function}
$D$ is \emph{continuous} in $p$. To see this, expand the equation above:
\scriptsize\[D_c = \gamma_c \left[ \left(\frac{-1}{\sum_{i=1}^c \gamma_i}\right) p_c
+ \left(\frac{1}{\sum_{i=1}^{c} \gamma_i} - \frac{1}{\sum_{i=1}^{c+1} \gamma_i} \right) p_{c+1}
%+ \left(\frac{1}{\sum_{i=1}^{c+1} \gamma_i} - \frac{1}{\sum_{i=1}^{c+2} \gamma_i}\right) p_{c+2}
+ \cdots
+ \left(\frac{1}{\sum_{i=1}^{|C|-1} \gamma_i} - \frac{1}{\sum_{i=1}^{|C|} \gamma_i}\right) p_{|C|}
+ \frac{1}{\sum_{i=1}^{|C|} \gamma_i}
\right]\]
\normalsize Since $D$ is linear in any neighborhood where the order of cutoffs is unambiguous, the only opportunity for discontinuity occurs when two or more cutoffs are equal. Thus, it suffices to show that the value of $D_c$ is independent of how ties among the $p_c$ are broken. Suppose that $p_j = \dots = p_{j+n} = \tilde p$ for some $j > c$. Then (dividing by $\gamma_c$ for legibility),
\scriptsize \begin{align}
\frac{D_c}{\gamma_c} &= \cdots
+ \left(\frac{1}{\sum_{i=1}^{j-1} \gamma_i} - \frac{1}{\sum_{i=1}^{j} \gamma_i} \right) p_{j}
+ \left(\frac{1}{\sum_{i=1}^{j} \gamma_i} - \frac{1}{\sum_{i=1}^{j+1} \gamma_i} \right) p_{j+1}
%+ \left(\frac{1}{\sum_{i=1}^{j+1} \gamma_i} - \frac{1}{\sum_{i=1}^{j+2} \gamma_i}\right) p_{j+2}
+ \cdots
+ \left(\frac{1}{\sum_{i=1}^{j+n} \gamma_i} - \frac{1}{\sum_{i=1}^{j+n+1} \gamma_i}\right) p_{j+n}
+ \cdots \\
&= \cdots
+ \left(\frac{1}{\sum_{i=1}^{j-1} \gamma_i} - \cancel{\frac{1}{\sum_{i=1}^{j} \gamma_i}} \right) \tilde p
+ \left(\cancel{\frac{1}{\sum_{i=1}^{j} \gamma_i}} - \cancel{\frac{1}{\sum_{i=1}^{j+1} \gamma_i}} \right) \tilde p
%+ \left(\cancel{\frac{1}{\sum_{i=1}^{j+1} \gamma_i}} - \cancel{\frac{1}{\sum_{i=1}^{j+2} \gamma_i}}\right) \tilde p 
+ \cdots
+ \left(\cancel{\frac{1}{\sum_{i=1}^{j+n} \gamma_i}} - \frac{1}{\sum_{i=1}^{j+n+1} \gamma_i}\right) \tilde p
+ \cdots \\
&= \cdots
+ \left(\frac{1}{\sum_{i=1}^{j-1} \gamma_i} - \frac{1}{\sum_{i=1}^{j+n+1} \gamma_i}\right) \tilde p
+ \cdots
\end{align}
\normalsize The internal sums that depend on the order of the indices $j \dots j+n$ cancel out; hence, they may be arbitrarily reordered without changing the value of $D_c$. Similar canceling shows that the demand does not vary under tiebreaking when $c$ itself is involved in a tie. Hence, $D$ is continuous in $p$. 

The expansion above also allows us to see that the demand vector is defined by the \emph{matrix equation}
\begin{equation}D = A p + \frac{1}{\Gamma}\gamma \label{demandmatrixeq}\end{equation}
where $A\in \mathbb{R}^{|C| \times |C|}$ is the triangular matrix with
\begin{align} \label{Adef}
A_{ij} &\equiv \begin{cases}
0, & i > j \\
-\gamma_i \left(\frac{1}{ \sum_{k=1}^i \gamma_k}\right), & i=j \\
\gamma_i \left( \frac{1}{\sum_{k=1}^{j-1} \gamma_k} -  \frac{1}{\sum_{k=1}^{j} \gamma_k}\right), & i<j \\
\end{cases} \\[.8em]
\implies A &= \begin{bmatrix}
\gamma_1 \left( \frac{-1}{\gamma_1} \right) & \gamma_1 \left(\frac{1}{\gamma_1} - \frac{1}{\gamma_1 + \gamma_2} \right) & \gamma_1 \left(\frac{1}{\gamma_1 + \gamma_2} - \frac{1}{\gamma_1 + \gamma_2 + \gamma_3} \right) & \cdots &  \gamma_1 \left(\frac{1}{\sum_{i=1}^{|C| - 1}\gamma_i} - \frac{1}{\Gamma}  \right)  \\
 & \gamma_2 \left( \frac{-1}{\gamma_1 + \gamma_2} \right) & \gamma_2 \left(\frac{1}{\gamma_1 + \gamma_2} - \frac{1}{\gamma_1 + \gamma_2 + \gamma_3} \right) & \cdots &  \gamma_2 \left(\frac{1}{\sum_{i=1}^{|C| - 1}\gamma_i} - \frac{1}{\Gamma} \right)  \\
 &  & \gamma_3 \left( \frac{-1}{\gamma_1 + \gamma_2 + \gamma_3} \right) & \cdots &  \gamma_3 \left(\frac{1}{\sum_{i=1}^{|C| - 1}\gamma_i} - \frac{1}{\Gamma} \right)  \\
 & & & \ddots & \vdots \\
 &  &  &  &  \gamma_{|C|} \left(\frac{1}{\sum_{i=1}^{|C| - 1}\gamma_i} -\frac{1}{\Gamma}  \right)  \\
\end{bmatrix}\end{align}

Since $\gamma > 0$, $A$ is invertible. 

Because the matrix $A$ depends on the order of the $p_c$ values, the demand function is \emph{piecewise linear} in $p$. In the context of an iterative schema like those discussed below, instead of sorting $p$ itself, it is often simpler to permute the rows and columns of $A$ according to the inverse of the permutation that sorts $p$. 

\subsubsection{Appeal function}
Another interesting indicator from Azevedo and Leshno \parencite*{supplydemandfw} is the \emph{appeal} of a school's entering class, or the integral of scores over the set of admitted students. The appeal of the entering class is not necessarily the school's objective function, because schools may value an abstract notion of selectivity or students' tuition dollars higher than this value. 

The average score of a student with consideration set $C_{[d]}$ is $\frac{1}{2}\left(p_{d+1} + p_d\right)$, so the appeal at $c$ is
\begin{align}
L_c &= \sum_{d=c}^{|C|} 
\underbrace{\frac{{\gamma_c}}{ \sum_{i=1}^d {\gamma_i}}}_{\substack{\text{prob. of choosing  }\\ c\text{ from cons. set}}} 
\overbrace{\left(p_{d+1} - p_{d}\right)}^{\substack{\text{prob. of having}\\ \text{cons. set }C_{[d]}}} 
\underbrace{\frac{1}{2}\left(p_{d+1} + p_{d}\right)}_{\substack{\text{avg. score of students}\\ \text{with cons. set }C_{[d]}}}
=\frac{1}{2}\sum_{d=c}^{|C|} 
\frac{{\gamma_c}}{ \sum_{i=1}^d {\gamma_i}} 
\left(p_{d+1}^2 -  p_{d}^2\right)
\end{align}
By comparison with the expression for $D$, the quality vector is given by 
\[L = \frac{1}{2} A p.^2 + \frac{1}{2\Gamma} \gamma\]
where the notation $p.^2 = (p_1^2, \dots, p_{|C|}^2)$ represents the entrywise square of $p$.




\subsection{Computing the equilibrium}
In the market under consideration, the equilibrium conditions are as follows:
\begin{gather} \label{ssmnleqconds}
\begin{aligned}
D = A p + \frac{1}{\Gamma}\gamma &\leq q \\
D_c = A_{c.} p + \frac{1}{\Gamma} \gamma_c &= q_c, \quad \forall c: p_c > 0
\end{aligned}
\end{gather}
Since $\eta$ has strong support, by Theorem \ref{strongsupportimpliesunique}, the equilibrium exists and is unique. Moreover, it turns out that the order of the optimal cutoffs is determined by the order of the ratios $\gamma_c / q_c$, and this fact  enables us to compute the equilibrium directly by solving a linear system. (Below, the positive part operator $x^+$ works entrywise on the elements of its argument $x$: $(x^+)_i \equiv \max\{0, x_i\}$.)

\begin{theorem} \label{cutoffsortationthm}
Without loss of generality, suppose that $\frac{\gamma_1}{q_1} \leq \dots \leq \frac{\gamma_{|C|}}{q_{|C|}}$. Then $\hat p_1 \leq \cdots \leq \hat p_{|C|}$, and
\[\hat p \equiv \left[A^{-1} (q - \frac{1}{\Gamma} \gamma) \right]^+\]
is the market equilibrium.
\end{theorem} 

\begin{proof}
I show the following statements:
\begin{enumerate}
\item $\hat p$ satisfies $\hat p_1 \leq \cdots \leq \hat p_{|C|}$. This means that the demand at $\hat p$ is given by the expression $A \hat p + \frac{1}{\Gamma}\gamma$ (which only holds if $\hat p$ is sorted).
\item $\hat p$ satisfies the equilibrium conditions given in equation \eqref{ssmnleqconds}.
\end{enumerate}
For convenience, let $\bar p \equiv A^{-1} (q - \frac{1}{\Gamma} \gamma) $, so that $\hat p = \bar p^+$. 

\underline{$\hat p$ is sorted.} Pick any school $c < |C|$. It suffices to show that $\bar p_{c+1} - \bar p_{c} \geq 0$. The inverse of $A$ is
\[A^{-1} = \begin{bmatrix}
\frac{-1}{\gamma_1}\left( \gamma_1 \right) & -1 & -1 &\cdots & -1 \\
 & \frac{-1}{\gamma_2}\left( \gamma_1 + \gamma_2 \right) & -1 &\cdots & -1 \\
 & & \frac{-1}{\gamma_2}\left( \gamma_1 + \gamma_2 + \gamma_3 \right) &\cdots & -1 \\
 &  &  & \ddots & \vdots \\
 & & & &  \frac{-1}{\gamma_{|C|}} \Gamma \\
\end{bmatrix}\]
It is not difficult to verify that
\begin{align*}
\bar p_{c+1} - \bar p_{c}
&= \left[A^{-1} (q - \frac{1}{\Gamma} \gamma) \right]_{c+1} - \left[A^{-1} (q - \frac{1}{\Gamma} \gamma) \right]_{c} = \left(\sum_{j=1}^c \gamma_j \right) \left(\frac{q_c}{\gamma_c} - \frac{q_{c+1}}{\gamma_{c+1}}\right) \geq 0
\end{align*}
which follows from the assumption that $\gamma_c / q_c \leq \gamma_{c+1} / q_{c+1}$.

\underline{$\hat p$ satisfies the equilibrium conditions.} The demand at $\hat p$ is $D = A \hat p + \frac{1}{\Gamma}\gamma$. Hence
\begin{align*}
\hat p = A^{-1} (D - \frac{1}{\Gamma} \gamma) = \bar p^+ &\geq \bar p = A^{-1} (q - \frac{1}{\Gamma} \gamma) \\
\implies \quad A^{-1} D &\geq A^{-1} q \\
\implies \quad D &\leq q
\end{align*}
The final statement follows from the fact that $A^{-1}$ is triangular and its nonzero entries are strictly negative. This establishes the capacity condition. 

Now, we need to show that the demand equals the capacity when $\hat p_c > 0$. Let $b$ denote the first school with a nonzero cutoff. That is, $\hat p_1 = \dots = \hat p_{b-1} = 0$, and $0 < \hat p_b \leq p_{b+1} \leq \dots \leq \hat p_{|C|}$. Then the demand at $\hat p$ may be written
\begin{gather*}\begin{aligned}
D &= A \hat p + \frac{1}{\Gamma}\gamma \\
&= \sum_{i=1}^{|C|} A_{.i} \hat p_i + \frac{1}{\Gamma}\gamma  \\
&= \sum_{i=1}^{|C|} A_{.i} \left[A^{-1} \left(q - \frac{1}{\Gamma}\gamma\right) \right]_i^+ + \frac{1}{\Gamma}\gamma  \\
&= \sum_{j=b}^{|C|} A_{.j} \left[A^{-1} \left(q - \frac{1}{\Gamma}\gamma\right) \right]_j + \frac{1}{\Gamma}\gamma  \\
&= \left[\sum_{j=b}^{|C|} A_{.j} A_{j.}^{-1} \right] \left(q - \frac{1}{\Gamma}\gamma\right) + \frac{1}{\Gamma}\gamma  \\
&= \begin{bmatrix}
0_{b \times b} & T_{b \times (|C| - b)} \\
0_{(|C| - b) \times b} & I_{|C| - b} \\
\end{bmatrix} \left(q - \frac{1}{\Gamma}\gamma\right) + \frac{1}{\Gamma}\gamma  \\
\end{aligned}\end{gather*}
where
\[T = \begin{bmatrix}
\frac{-\gamma_1}{\sum_{i=1}^{b-1} \gamma_i} & \cdots & \frac{-\gamma_1}{\sum_{i=1}^{b-1} \gamma_i} \\
\vdots & \cdots & \vdots \\
\frac{-\gamma_{b-1}}{\sum_{i=1}^{b-1} \gamma_i} & \cdots & \frac{-\gamma_{b-1}}{\sum_{i=1}^{b-1} \gamma_i}
\end{bmatrix}\]
For the schools with $\hat p_c > 0$, the demand is
\begin{align*}
D_c &=
\begin{bmatrix}
0& I
\end{bmatrix}_{c.} \left(q - \frac{1}{\Gamma}\gamma\right) + \frac{1}{\Gamma}\gamma
= q_c
\end{align*}
Hence, the stability criterion holds, and $\hat p$ is an equilibrium.\end{proof}

For reference, for the schools with $p_c = 0$, the demand is 
\begin{align*}
D_c &=
\begin{bmatrix}
0& T
\end{bmatrix}_{c.} \left(q - \frac{1}{\Gamma}\gamma\right) + \frac{1}{\Gamma}\gamma  
= \frac{-\gamma_c}{\sum_{i=1}^{b-1} \gamma_i} \sum_{j=b}^{|C|} \left(q_j - \frac{1}{\Gamma}\gamma_j\right)  + \frac{1}{\Gamma}\gamma_c \leq q_c
\end{align*}
%From this expression, we can derive the minimum value of $\gamma_c$ that will cause $c$ to meet its capacity at equilibrium. 
% Statement above is not true, because changing gamma would change the order.

\subsection{Validation}
In this section, I offer a numerical demonstration of the cutoff sort order given by Theorem \ref{cutoffsortationthm}. Additionally, I validate the interpretation of the equilibrium cutoffs as a stationary point of a t\^{a}tonnement process, as a market-clearing price vector, and as the limit point of stable assignments. (The demonstration of the latter two interpretations follows Azevedo and Leshno \parencite*{supplydemandfw}.)

Figure \ref{gammaq-pstar} demonstrates the relationship between the equilibrium cutoffs $p_c^*$ and the competitiveness ratios $\gamma_c / q_c$ in randomly generated markets. Some of the markets are overdemanded, yielding $p^* > 0$, and others are underdemanded; however, the equilibrium cutoffs are always ordered according to the competitiveness ratios. As the graph indicates, the precise relationship is nonlinear and highly sensitive to variance in the market parameters. This suggests that even in the highly stylized model under consideration, it is difficult to predict the effect of small perturbation in a single $\gamma_c$ or $q_c$ value on the market as a whole simply from looking at the equilibrium assignment of students. 

\begin{figure}
\begin{center}\includegraphics[width=\linewidth, ]{plots/gammaq-pstar.pdf}\end{center}
\captionsetup{singlelinecheck=off}
    \caption[.]{Competitiveness ratios $\gamma_c / q_c$ and equilibrium cutoffs $p_c^*$ in 16 randomly generated admissions markets each containing 20 schools. The preferability parameters $\delta_c$ are drawn from $\operatorname{Uniform(0, 1)}$; then each $\gamma_c \equiv \exp \delta_c / \sum_{j \in C} \exp \delta_j$. The capacities are drawn from $\operatorname{Uniform(0, 1/20)}$; hence the market as a whole has a 50 percent chance of being over- or underdemanded. The figure shows that the order of the equilibrium cutoffs is determined by the order of competitiveness ratios.}
\label{gammaq-pstar}
\end{figure}

Figures \ref{tat-iter-cutoff} through \ref{score-DA-placement} consider a fictional admissions market called Birchtown, which has the following parameters. I have sorted the schools by their optimal cutoffs:
\begin{align*}
\gamma &=  \textstyle{\left(\frac{2}{12}, \frac{1}{12}, \frac{3}{12}, \frac{6}{12}\right)}\\
q &= (0.3, 0.1, 0.2, 0.2) \\
p^* &= (0.2, 0.3, 0.4, 0.6)\\
D(p^*, \gamma) &=  (0.3, 0.1, 0.2, 0.2)
\end{align*}
As the total capacity is less than one, each school fills its capacity at equilibrium.

Figure \ref{tat-iter-cutoff} shows fifty iterations of the simultaneous t\^{a}tonnement process (Algorithm \ref{admissionseqtatalgo}) applied to Birchtown. At each iteration, the demand is computed directly by evaluating the expression derived above (\eqref{mnlonetestdemand}). Then, the cutoff vector is adjusted in the direction of excess demand according to a predetermined, decreasing sequence of step size. The cutoffs converge smoothly toward $p^*$, which suggests the continuity of the demand function and the stability of the equilibrium. 

Figures \ref{score-cutoff-choice} and \ref{score-DA-placement} consider discrete approximations of the Birchtown admissions markets with 20, 200, or 2000 students. In Figure \ref{score-cutoff-choice}, schools admit students according to their equilibrium cutoffs, students choose their favorite school, and schools observe their demand. When there are many students, the demand at each school approximately equals its capacity. In Figure \ref{score-DA-placement}, a stable matching of the students is computed so that each school fills its capacity exactly. When there are many students, the implied cutoffs approximately equal $p^*$. 

Compare Figures \ref{score-cutoff-choice} and \ref{score-DA-placement} with Figure 4 of Azevedo and Leshno \parencite*{supplydemandfw}, which demonstrates the asymptotic convergence of implicit cutoffs as the number of students increases using a numerical experiment in which scores are partially correlated between schools. 

\begin{figure}
\begin{center}\includegraphics[width=\linewidth, ]{plots/tat-iter-cutoff.pdf}\end{center}
\captionsetup{singlelinecheck=off}
    \caption[.]{Convergence of fifty iterations of the simultaneous t\^{a}tonnement process (Algorithm \ref{admissionseqtatalgo}) in the fictional nonatomic admissions market of Birchtown (see text). The step size parameters are $\alpha = 0.2, \beta = 0.01$, and the initial cutoff vector is $p^{(0)} = (0.15, 0.15, 0.15, 0.15)$. }
\label{tat-iter-cutoff}
\end{figure}




\begin{figure}
\begin{center}\includegraphics[width=\linewidth, ]{plots/score-cutoff-choice.pdf}\end{center}
\captionsetup{singlelinecheck=off}
    \caption[.]{Simulation of a decentralized school-choice process in Birchtown. A discrete sample of student preference lists and scores is drawn from $\eta$. Each school admits students whose score exceeds its equilibrium cutoff (shown as vertical lines), then each student chooses her favorite school from her consideration set. As the sample size increases, the demand at each school approximately equals its scaled capacity.}
\label{score-cutoff-choice}
\end{figure}



\begin{figure}
\begin{center}\includegraphics[width=\linewidth, ]{plots/score-DA-placement.pdf}\end{center}
\captionsetup{singlelinecheck=off}
    \caption[.]{Simulation of a deferred acceptance process in Birchtown. A discrete sample of student preference lists and scores is drawn from $\eta$. The student-proposing deferred acceptance algorithm (Algorithm \ref{studentproposingDA}) is used to compute a stable matching. The score of the least-qualified admit at each school, or the school's implied score cutoff, is computed and represented as a vertical line. Regardless of the sample size, each school fills its scaled capacity, and as the sample size increases, the implied cutoffs approach the market equilibrium. Comparison with Figure \ref{tat-iter-cutoff} and Figures \ref{score-cutoff-choice} suggests the equivalence among t\^{a}tonnement equilibrium, market clearing cutoffs, and stable assignments in nonatomic admissions markets.}
\label{score-DA-placement}
\end{figure}






\subsection{Unconstrained comparative statics}
First, I derive comparative statics results that apply to an unconstrained market in which schools have no capacity constraints. This section makes no particular claim about what schools' objective functions are; rather, I simply compute the gradients of the demand and appeal functions with respect to $p$, and $\gamma$ using the relations $D = Ap + \gamma$ and $L = \frac{1}{2} A p.^2 + \frac{1}{2}\gamma$ and discuss their interpretations. These quantities prove useful in the following section, in which I quantify the incentives available to schools under a centralized admissions procedure that always produces a stable matching. 

\subsubsection{Cutoff effects}
The change in demand in response to a change in cutoffs is the Jacobian of the demand function:
\[\mathbf{J}_p D = A \]
The diagonal is negative, meaning that each school's demand is decreasing in its cutoff (downward-sloping demand curves). The entries above the diagonal are positive, while those below the diagonal are zero. This means that each school $c$'s demand is increasing in the cutoffs of the \emph{more-selective} schools, but the cutoffs of \emph{less-selective schools} have no local effect on the demand at $c$.

Intuitively, this means that if all schools are equally preferable, a highly selective school has more market power than the others: If it increases its cutoff, it will cause many students to move onto another school. On the other hand, a school $c'$ that is less preferable than $c$ cannot affect $D_c$'s demand by changing its own cutoff, because any student currently admitted to $c$ was already admitted to $c'$, and chose $c$ instead. 

Observe also that $-1 = A_{11} < A_{22} < \dots < A_{|C||C|} < 0$. This says that the school with the most generous cutoff has the most power to increase its demand with a marginal decrease in $p_c$. Intuitively, this is because a student who gets into a school with a large cutoff gets into \emph{many} schools, so competition for this student is fiercer than for a student whose options are already limited by a low score.

Next, consider the change in the entering classes' \emph{appeal} in response to a change in cutoffs:
\[\mathbf{J}_p L = A\operatorname{diag}(p)\]
For $p_c > 0$, the cutoff effect on appeal has the same direction as the cutoff effect on demand. Intuitively, this suggests that if a school's goal is to maximize the appeal of its entering class, it will tend to try to lower its score cutoffs as much as it can, subject to constraints on its total demand. However, the magnitude of the incentive increases when $p_c$ is higher. This tends to counteract the market power effect described above: A school with a low cutoff has the power to attract more marginal students, but does so with little overall effect on the aggregate appeal of its entering class. In the extreme case, when $p_c = 0$, the appeal associated with a marginal student is exactly zero.

The derivatives given above are well-defined when the cutoffs are totally ordered. However, an edge case occurs when there is a tie among the cutoffs; then the subdifferential set is given by the convex hull of the Jacobians associated with the possible permutations of $p$. In this case, I argue that the best interpretation of the effect of an \emph{increase} in $p_c$ should be that associated with the permutation for which $c$ is indexed after schools with which its cutoff is tied. That is, because $p_c$ is "about to" become larger than the other cutoffs involved in the tie, break the tie in its favor. Likewise, to interpret a \emph{decrease} in a tied $p_c$, treat $p_c$ as the least member of the tied set.

\subsubsection{Quality effects}
Differentiate the demand with respect to $\gamma$ to obtain the effect of a marginal change in quality:
\[\frac{\partial}{\partial\gamma_{\hat c}} D_c = \begin{cases}
\sum_{d=c}^{|C|} \frac{-\gamma_c}{\left(\sum_{i=1}^{d} \right)^2} \left(p_{d+1} - p_d \right), & \hat c < c \\
\sum_{d=c}^{|C|} \frac{1}{\left(\sum_{i=1}^{d} \right)}
    \left( 1 - \frac{\gamma_c}{\left(\sum_{i=1}^{d} \right)}\right)
    \left(p_{d+1} - p_d \right), & \hat c = c\\
\sum_{d=\hat c}^{|C|} \frac{-\gamma_c}{\left(\sum_{i=1}^{d} \right)^2} \left(p_{d+1} - p_d \right), & \hat c > c
\end{cases}\]

(Note that the $\hat c > c$ and $ \hat c < c$ cases differ in the starting index.) The demand for $c$ is predictably decreasing in the quality of the other schools and increasing in $\gamma_c$. 

A similar picture emerges when we differentiate the appeal with respect to $\gamma$:
\[\frac{\partial}{\partial\gamma_{\hat c}} L_c = \begin{cases}
\frac{1}{2}\sum_{d=c}^{|C|} \frac{-\gamma_c}{\left(\sum_{i=1}^{d} \right)^2} \left(p_{d+1}^2 - p_d^2 \right), & \hat c < c \\
\frac{1}{2}\sum_{d=c}^{|C|} \frac{1}{\left(\sum_{i=1}^{d} \right)}
    \left( 1 - \frac{\gamma_c}{\left(\sum_{i=1}^{d} \right)}\right)
    \left(p_{d+1}^2 - p_d^2 \right), & \hat c = c\\
\frac{1}{2}\sum_{d=\hat c}^{|C|} \frac{-\gamma_c}{\left(\sum_{i=1}^{d} \right)^2} \left(p_{d+1}^2 - p_d^2 \right), & \hat c > c
\end{cases}\]

By the same procedure used to show the continuity of $D$ above, it is easy to see that the quality effects are continuous across tiebreaking permutations of $p$.





\subsection{Quality effects at equilibrium} \label{compstateq}
Now, let's analyze the incentives available to schools when the market is constrained to equilibrium, for example, by a centralized admissions process that uses a DA algorithm to produce a stable matching. In this section, I will focus on the effect of a marginal change in quality on market, with the understanding that when a single school changes its quality, the location of the equilibrium changes. Throughout this section, I assume the schools schools are indexed in ascending order by the competitiveness ratios $\gamma_c / q_c$, and that no ties occur among these ratios or among the equilibrium cutoffs, to avoid the undefined derivatives that can occur in the edge cases discussed above. 

First, I provide yet another expression for the equilibrium cutoff vector $\hat p$, which can be verified by expanding the equation given in Theorem \ref{cutoffsortationthm}. $\hat p_c = \bar p_c^+$, where
\begin{equation}
\bar p_c = 
\frac{1}{\gamma_c} \left(\frac{\gamma_c}{\Gamma} - q_c\right) \sum_{i=1}^{c} \gamma_i 
+ \sum_{j=c+1}^{|C|} \left( \frac{\gamma_j}{\Gamma} - q_j \right)
\end{equation}
This assumes the schools are indexed in ascending order by the competitiveness ratios $\gamma_c / q_c$. 

Differentiating with respect to the quality, we have
\[\frac{\partial}{\partial\gamma_{\hat c}} \hat p_c = \begin{cases}
0, & \bar p_c < 0 \\
\text{undefined}, & \bar p_c = 0 \\
\frac{1}{\Gamma} - \frac{q_c}{\gamma_c}, & \bar p_c > 0 \text{ and }\hat c < c \\
\frac{1}{\Gamma} + \frac{q_c}{\gamma_c^2} \sum_{i=1}^{c-1} \gamma_i, & \bar p_c > 0 \text{ and }\hat c = c\\
\frac{1}{\Gamma}, & \bar p_c > 0 \text{ and }\hat c > c
\end{cases}\]
The most interesting case is the third, whose sign depends on the competitiveness ratio. For a school that fills its capacity, if $c$ has a high competitiveness ratio, then a marginal increase in quality at a school that is less competitive overall can make $c$ become \emph{more difficult} to get into, a counterintuitive result.
% Numerical experiments do not seem do support this. Needs investigation 

\subsubsection{At equilibrium: Demand effects}
On cutoff when quality is fixed

Effect of a change in total student population (i.e. scaling capacity)
Effect of a change in capacity








\subsection{Reverse optimization of student preferences}
Compute gamma; show inductive procedure. Argue for the informational power of this gamma. 





\section{Extensions}
Propose my general form of the dynamic admissions market.

Equivalent problems to equilibrium:
- variational inequality
- convex program

Its complexity; the number of potential preference lists and consideration sets.

Computable instances include mine and iid scores.

Admissions coalitions and clusters. 
\pagebreak
\printbibliography

\end{document}  